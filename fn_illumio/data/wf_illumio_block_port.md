<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Illumio: Block Port

## Function - Illumio: Create Virtual Service

### API Name
`illumio_create_virtual_service`

### Output Name
`virtual_service`

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_port = rule.properties.illumio_port
inputs.illumio_protocol = rule.properties.illumio_protocol
inputs.illumio_virtual_service_name = "VS-IBM-SOAR-{0}-{1}".format(str(rule.properties.illumio_port), rule.properties.illumio_protocol)
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Run Traffic Analysis

### API Name
`illumio_run_traffic_analysis`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
from datetime import datetime, timezone, timedelta

inputs.illumio_port = rule.properties.illumio_port
inputs.illumio_protocol = rule.properties.illumio_protocol

start_time = rule.properties.illumio_block_port_traffic_analysis_start_time
end_time = rule.properties.illumio_block_port_traffic_analysis_end_time

inputs.illumio_traffic_analysis_start_time = start_time
inputs.illumio_traffic_analysis_end_time = end_time

```

### Post-Processing Script
```python
INCIDENT_TABLE_MAX_ROWS = 100


def convert_protocol(proto):
    return 'TCP' if proto == 6 else 'UDP' if proto == 17 else 'Unknown'


def service_details_to_string(service):
    service_string = ''
    for k,v in service.items():
        if k != 'port' and k != 'proto':
            service_string += '<br/>{0}: {1}'.format(k.replace('_', ' ').capitalize(), v)
    return service_string


def add_traffic_flow_table_row(flow):
    row = incident.addRow('illumio_traffic_flows')
    row['source_ip'] = flow['src']['ip']
    row['destination_ip'] = flow['dst']['ip']
    row['port'] = flow['service']['port']
    row['protocol'] = convert_protocol(flow['service']['proto'])
    row['flows'] = flow['num_connections']
    row['first_detected'] = flow['timestamp_range']['first_detected']
    row['last_detected'] = flow['timestamp_range']['last_detected']
    detail_string = "Valid network traffic found by Block Port workflow."
    service_details = service_details_to_string(flow['service'])
    if service_details:
        detail_string += "<br/><br/>Service details: {0}".format(service_details)
    row['flow_details'] = detail_string

flows = results.content['traffic_flows']
sorted_flows = sorted(flows, key=lambda x: x.get('num_connections', 0), reverse=True)
traffic_flow_workloads = set()

stored_rows = 0

for flow in sorted_flows:
    if 'workload' in flow['dst'] and 'href' in flow['dst']['workload']:
        # store traffic flows with the highest flow count returned from the analysis
        if stored_rows < INCIDENT_TABLE_MAX_ROWS:
            add_traffic_flow_table_row(flow)
            stored_rows += 1
        traffic_flow_workloads.add(flow['dst']['workload']['href'])

workflow.addProperty('traffic_flow_workloads', {'hrefs': list(traffic_flow_workloads)})
incident.addNote(
    helper.createRichText(
        u"<b>Illumio: Block Port</b> workflow: found <b>{0}</b> distinct traffic flows".format(len(traffic_flow_workloads))
    )
)

```

---

## Function - Illumio: Provision Objects

### API Name
`illumio_provision_objects`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_policy_object_hrefs = workflow.properties.virtual_service.content['href']
```

### Post-Processing Script
```python
if results.content['provisioned_hrefs']:
    active_href = results.content['provisioned_hrefs'][0]
else:
    active_href = workflow.properties.virtual_service.content['href']

workflow.addProperty('virtual_service_active_href', {'href': active_href})
incident.addNote(
    helper.createRichText(
        u"<b>Illumio: Block Port</b> workflow: provisioned virtual service with HREF <b>{0}</b>.".format(active_href)
    )
)

```

---

## Function - Illumio: Create Service Binding

### API Name
`illumio_create_service_binding`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_virtual_service_href = workflow.properties.virtual_service_active_href['href']
inputs.illumio_workload_hrefs = ','.join(workflow.properties.traffic_flow_workloads['hrefs'])
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Create Ruleset

### API Name
`illumio_create_ruleset`

### Output Name
`ruleset`

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_ruleset_name = "RS-IBM-SOAR-{0}-{1}".format(str(rule.properties.illumio_port), rule.properties.illumio_protocol)
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Get IP List

### API Name
`illumio_get_ip_list`

### Output Name
`any_ip_list`

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
None
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Create Enforcement Boundary

### API Name
`illumio_create_enforcement_boundary`

### Output Name
`enforcement_boundary`

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_port = rule.properties.illumio_port
inputs.illumio_protocol = rule.properties.illumio_protocol
inputs.illumio_enforcement_boundary_name = "EB-IBM-SOAR-{0}-{1}".format(str(rule.properties.illumio_port), rule.properties.illumio_protocol)
inputs.illumio_enforcement_boundary_consumers = workflow.properties.any_ip_list.content['href']
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Update Workload Enforcement Mode

### API Name
`illumio_update_workload_enforcement_mode`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_workload_hrefs = ','.join(workflow.properties.workload_hrefs['hrefs'])
```

### Post-Processing Script
```python
incident.addNote(
    helper.createRichText(
        u"<b>Illumio: Block Port</b> workflow: moved all <b>Visibility Only</b> managed workloads into <b>Selective</b> enforcement."
    )
)

```

---

## Function - Illumio: Create Rule

### API Name
`illumio_create_rule`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_ruleset_href = workflow.properties.ruleset.content['href']
inputs.illumio_rule_consumers = workflow.properties.any_ip_list.content['href']
inputs.illumio_rule_providers = workflow.properties.virtual_service_active_href['href']
```

### Post-Processing Script
```python
None
```

---

## Function - Illumio: Get Workloads

### API Name
`illumio_get_workloads`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
None
```

### Post-Processing Script
```python
workload_hrefs = [workload['href'] for workload in results.content['workloads']]
workflow.addProperty('workload_hrefs', {'hrefs': workload_hrefs})

```

---

## Function - Illumio: Provision Objects

### API Name
`illumio_provision_objects`

### Output Name
``

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_policy_object_hrefs = workflow.properties.enforcement_boundary.content['href']
```

### Post-Processing Script
```python
incident.addNote(
    helper.createRichText(
        u"<b>Illumio: Block Port</b> workflow: provisioned enforcement boundary with HREF <b>{0}</b> to block inbound traffic not explicitly allowed by rules on <b>{1} {2}</b>.".format(
            workflow.properties.enforcement_boundary.content['href'],
            rule.properties.illumio_port, rule.properties.illumio_protocol
        )
    )
)
```

---

## Function - Illumio: Provision Objects

### API Name
`illumio_provision_objects`

### Output Name
`None`

### Message Destination
`illumio_message_queue`

### Pre-Processing Script
```python
inputs.illumio_policy_object_hrefs = workflow.properties.ruleset.content['href']
```

### Post-Processing Script
```python
from datetime import datetime


def convert_soar_timestamp_to_iso(timestamp):
    iso_date = datetime.utcfromtimestamp(timestamp / 1000)  # convert from ms to seconds
    return '{0}{1}'.format(iso_date.isoformat(), '+00')  # express times in UTC

start_time = convert_soar_timestamp_to_iso(rule.properties.illumio_block_port_traffic_analysis_start_time)
end_time = convert_soar_timestamp_to_iso(rule.properties.illumio_block_port_traffic_analysis_end_time)

incident.addNote(
    helper.createRichText(
        u"<b>Illumio: Block Port</b> workflow: provisioned allow rule on <b>{0} {1}</b> for inbound traffic found between <b>{2}</b> and <b>{3}</b>.".format(
            rule.properties.illumio_port,
            rule.properties.illumio_protocol,
            start_time, end_time
        )
    )
)
```

---

